\documentclass{article}
% \IEEEoverridecommandlockouts
% The preceding line is only needed to identify funding in the first footnote. If that is unneeded, please comment it out.
\usepackage{cite}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{float}
\usepackage{xcolor}
\usepackage{tikz}
\usepackage{mdframed}
\usepackage{hyperref}
\usepackage{algorithm}
\usepackage{caption}
\usepackage{algpseudocode}
\usepackage{accents}
\usepackage{pgfplots}
\usepackage{filecontents}  
\usepackage{listings}

\usetikzlibrary{matrix}

\newcommand{\gridCellWidth}{0.3}
\newcommand{\gridSize}{7}
\newcommand{\gridSpacing}{0.9}
\newcommand{\gridWidth}{\gridSize*\gridCellWidth}

\newcommand{\gridAxisHorizontalCellColour}{myGreen}
\newcommand{\gridAxisVerticalCellColour}{myOrange}
\newcommand{\gridAxisMiddleColour}{myYellow}
\newcommand{\gridTwoStart}{\gridWidth + \gridSpacing}
\newcommand{\gridThreeStart}{2*\gridWidth + 2*\gridSpacing}

\newcommand{\graphLineSpacing}{0.5}
\newcommand{\graphTensorSpacing}{1}
\newcommand{\graphTensorTwoStart}{1.5*\graphTensorSpacing}
\newcommand{\graphTensorThreeStart}{\graphTensorTwoStart+ 2*\graphTensorSpacing}
\newcommand{\graphTensorFourStart}{\graphTensorThreeStart+ 2*\graphTensorSpacing}

% \def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
%     T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
\begin{document}

\definecolor{myGreen}{RGB}{95,173,86}
\definecolor{myYellow}{RGB}{242,193,78}
\definecolor{myOrange}{RGB}{247,129,84}
\definecolor{myBlue}{RGB}{118,146,255}
\definecolor{myBrown}{RGB}{90,42,39}
\definecolor{myGrey}{RGB}{238, 228, 225}
\definecolor{myFigureColour}{RGB}{240, 240, 240}

\title{TensorStencil Report}

% \author{\IEEEauthorblockN{Robert Buxton}
% \IEEEauthorblockA{rb419@ic.ac.uk}}

\maketitle

% \begin{abstract}

% \end{abstract}

% \begin{IEEEkeywords}
% Todo
% \end{IEEEkeywords}


\section{Abstract}
We propose an alternative to the ADD METHODS method for stencil computation.
Using tensors contractions use to represent stencil time step updates we can calculate the state of input data after an arbitrary number of time steps in a single pass.
The algorithm can make better use of recent TPU/GPU developments as it is primarily time bound by two groups of matrix multiplications.
\\ \\ This leads to an algorithm that is a for an $k$ dimensional stencil computing $t$ timesteps $O(n^{k+1})$ as opposed to classical loop algorithms which are $O(n^{k}t)$.

\section{Background}


\section{Introduction}
% Todo (Make better use of tensor cores/gpu matrix multipliers for stencil computation)
% \section{Method}
% I propose an alternative to the classical iterative loop method for stencil computation. 
% Using the emergent properties of the transformation matrices use to represent stencil time step update we can calculate the state of input data after an arbitrary number of time steps. 

\subsection{Representing a stencil as matrix multiplications}

The first step we need to take is to represent the star stencil loop in terms of a matrices multiplications.
This isn't very difficult as any star stencil can just be broken down into a individual transformation matrix for each of it's dimensions \cite{10.1145/3524059.3532392}.
The example below is for a 2D 5 wide star stencil. \\

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/stencil_split.tex} \\
		\input{diagrams/vertical_stencil_to_toeplitz.tex} \\
		\input{diagrams/horizontal_stencil_to_toeplitz.tex}
		\caption{Breaking a stencil down into matrix transformations}
	\end{mdframed}
\end{figure}

In 2D a single time step iteration can be represented as a left side matrix multiplication of the Y stencil transformation added to a right side matrix multiplication of the X transformation (which is transposed) \\

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/matrix_iteration.tex}
		\caption{A 2D stencil timestep update in matrix form}
		\label{stencil timestep}
	\end{mdframed}
\end{figure}

\subsection{Representing a stencil as tensors}

Before switching to higher dimensional stencils we must first introduce a new notation as we begin to deal with tensors.
If you are not familiar with tensors you can (with caveats) just think of them as matrices in higher dimensions. A 1D tensor is a vector, A 2D tensor is a matrix and a tensor contraction between two 2d tesnors is just a matrix multiplication (if on the correct indices, otherwise it is a transposed multiplication) \\

A tensor contraction of the form $\sum_j M_{ij}N_{jkl}$ can be notated as \\

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/tensor_diagram_notation.tex}
		\caption{An example in tensor diagram notation}
	\end{mdframed}
\end{figure}

in \href{http://tensornetwork.org/diagrams/}{Tensor Diagram Notation} \\

Using this notation we can express Figure \ref{stencil timestep} in terms of tensors

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/tensor_two_d_generic_iteration.tex}
		\caption{A 2D stencil timestep update in tensor form}
		\label{tensor timestep}
	\end{mdframed}
\end{figure}

By self substitution of Figure \ref{tensor timestep} one time we can show two time steps as

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/tensor_two_d_two_iteration.tex}
		\caption{A 2D stencil timestep updatde twice}
	\end{mdframed}
\end{figure}

If you repeat this indefinitely you end up with the generalized form.

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/tensor_two_d_t_iteration.tex}
		\caption{A 2D stencil timestep updated t times}
		\label{tensor timestep 2D}
	\end{mdframed}
\end{figure}

This can be generalized to 3D and ND in Fig \ref{tensor timestep 3D} and Fig \ref{tensor timestep ND} respectively.


\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/tensor_three_d_t_iteration.tex}
		\caption{A 3D stencil timestep updated t times}
		\label{tensor timestep 3D}
	\end{mdframed}
\end{figure}

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/tensor_n_d_t_iteration.tex}
		\caption{A ND stencil timestep updated t times}
		\label{tensor timestep ND}
	\end{mdframed}
\end{figure}

\subsection{eigendecomposition of toeplitz matrices}

Before moving onto simplifications we can make to the tensor expression we have in Fig \ref{tensor timestep 2D} - \ref{tensor timestep ND} we must look into how we can eigendecompose the transformation matrices we apply to each dimension.

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
		\input{diagrams/matrix_eigen_decomposition.tex}
		\caption{A ND stencil timestep updated t times}
	\end{mdframed}
\end{figure}

You can eigendecompose a tridiagonal toeplitz analytically and higher orders can be done incrementally \cite{bogoya2022fast}
The eigendecomposition for tridiagonal toeplitz matrices that arise from 3 wide stencils is as follows.


\[ i,j = 1:n\]
\[ {Q_X}_{i,i} = \frac{m}{2} + 2\sqrt{x1 x2}\cos{\frac{i\pi}{n+1}}\]
\[ {\Lambda_X}_{i,j} = (\frac{x1}{x2})^{\frac{j}{2}}\sin{\frac{ij\pi}{n+1}} \]

This eigendecomposition can be represented in tensor graph notation.

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
	\input{diagrams/tensor_eigen_decomposition.tex}
	\caption{A tensor eigendecomposition}
\end{mdframed}
\end{figure}

Sequential matrix transformations by the same matrix can be eigendecomposed simply

\begin{figure}[H]
	\begin{mdframed}[backgroundcolor=myFigureColour]
	\input{diagrams/tensor_n_eigen_decomposition.tex}
	\caption{A tensor eigendecomposition to the power of i}
\end{mdframed}
\end{figure}

This is because sequential $Q_X$ and $Q_X^{-1}$ cancel out.

\subsection{Hadamard product}

Before going any further we need to introduce the Hadamard product operator.
On a given tensor it is just an element wise multiplication. \\

$\circ$ the Hadamard Product means ${(A \circ B)}_{ij} = (A)_{ij} (B)_{ij}$ \\

\input{diagrams/sumation_hadamard_identity.tex}

\subsection{3D Formula}
\input{diagrams/3d_complete_tensor_stencil.tex}
\input{diagrams/eigen_scale.tex}


\subsection{Generalized Formula}
\input{diagrams/nd_complete_tensor_stencil.tex}

\include{diagrams/graphs.tex}

% \section{Proof}

% Todo
% \section{Complexity}
% Todo
% \section{Results}
% Todo

\bibliographystyle{ieeetr}
\bibliography{citation}

\end{document}